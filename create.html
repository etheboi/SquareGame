// Import necessary modules
const http = require('http');
const fs = require('fs');
const path = require('path');

// Port configuration
const port = 5000;

// Initialize the accounts array
let accounts = [];

// Load existing accounts from file (if any)
const accountsFilePath = path.join(__dirname, 'accounts.json');

if (fs.existsSync(accountsFilePath)) {
    const accountsData = fs.readFileSync(accountsFilePath, 'utf-8');
    try {
        accounts = JSON.parse(accountsData);
        if (!Array.isArray(accounts)) {
            accounts = [];
        }
    } catch (err) {
        console.error('Error parsing accounts file:', err);
        accounts = [];
    }
}

// Function to save accounts to file
const saveAccounts = () => {
    fs.writeFileSync(accountsFilePath, JSON.stringify(accounts, null, 2), 'utf-8');
};

// Create the server
const server = http.createServer((req, res) => {
    const { method, url } = req;

    if (method === 'OPTIONS') {
        res.writeHead(204, {
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type',
            'Access-Control-Max-Age': 2592000, // 30 days
        });
        res.end();
        return;
    }

    if (url === '/create' && method === 'POST') {
        let body = '';

        req.on('data', chunk => {
            body += chunk.toString();
        });

        req.on('end', () => {
            try {
                const data = JSON.parse(body);

                // Check if request is valid
                if (data.request !== 'create' || !data.username || !data.email || !data.password) {
                    res.writeHead(400, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });
                    res.end(JSON.stringify({ response: 'invalid_request' }));
                    return;
                }

                // Check if accounts array is valid
                if (!Array.isArray(accounts)) {
                    accounts = [];
                }

                // Check if the email or username already exists
                const emailExists = accounts.some(account => account.email === data.email);
                const usernameExists = accounts.some(account => account.username === data.username);

                if (emailExists) {
                    res.writeHead(200, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });
                    res.end(JSON.stringify({ response: 'email_exists' }));
                } else if (usernameExists) {
                    res.writeHead(200, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });
                    res.end(JSON.stringify({ response: 'username_exists' }));
                } else {
                    // Create new account
                    accounts.push({
                        username: data.username,
                        email: data.email,
                        password: data.password, // In a real application, hash the password before storing it
                    });

                    // Save updated accounts array to file
                    saveAccounts();

                    res.writeHead(200, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });
                    res.end(JSON.stringify({ response: 'successful' }));
                }
            } catch (err) {
                console.error('Error handling request:', err);
                res.writeHead(500, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });
                res.end(JSON.stringify({ response: 'server_error' }));
            }
        });
    } else {
        // Handle 404 Not Found
        res.writeHead(404, { 'Content-Type': 'text/plain', 'Access-Control-Allow-Origin': '*' });
        res.end('404 Not Found');
    }
});

// Start the server
server.listen(port, () => {
    console.log(`Server running on port ${port}`);
});
